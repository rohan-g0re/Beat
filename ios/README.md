# iOS Native Code

This directory contains iOS-specific native code for FitTracker, including the WidgetKit extension.

## ⚠️ Important Notes

1. **This folder is NOT committed in a managed Expo workflow**
   - The `ios/` folder is auto-generated by `npx expo prebuild`
   - It should be in `.gitignore` for managed workflow
   - Only commit if using bare workflow

2. **Widget Extension Setup (Milestone M9)**
   - Widgets require Swift/SwiftUI (no JavaScript alternative)
   - Must run `npx expo prebuild` first to generate Xcode project
   - Then manually add Widget Extension target in Xcode

## Setup Instructions (Phase 2 - Widgets)

### 1. Generate iOS Project

```bash
npx expo prebuild --platform ios
```

### 2. Open in Xcode

```bash
open ios/FitTracker.xcworkspace
```

### 3. Add Widget Extension Target

1. In Xcode: File → New → Target
2. Choose "Widget Extension"
3. Name: `FitTrackerWidget`
4. Bundle ID: `com.fittracker.app.FitTrackerWidget`
5. Check "Include Configuration Intent"

### 4. Copy Widget Files

Copy the Swift files from this directory into the Widget Extension target:

- `FitTrackerWidget/FitTrackerWidget.swift`
- `FitTrackerWidget/WidgetViews.swift`
- `FitTrackerWidget/WidgetTimelineProvider.swift`
- `Shared/SharedDataManager.swift`
- `Shared/WidgetData.swift`

### 5. Configure App Groups

1. Select main app target → Signing & Capabilities
2. Add "App Groups" capability
3. Add group: `group.com.fittracker.app`
4. Select Widget Extension target
5. Add same "App Groups" capability with same group ID

### 6. Update Entitlements

Ensure `FitTracker.entitlements` includes:

```xml
<key>com.apple.security.application-groups</key>
<array>
    <string>group.com.fittracker.app</string>
</array>
```

### 7. Create Native Module Bridge (React Native → Swift)

Create a native module in React Native to write widget data:

```typescript
// src/services/widgetBridge.ts
import { NativeModules } from 'react-native';

const { WidgetBridge } = NativeModules;

export const updateWidgetData = (data: {
  currentStreak: number;
  longestStreak: number;
  lastWorkoutDate: string | null;
  totalWorkouts: number;
}) => {
  if (WidgetBridge) {
    WidgetBridge.updateWidget(data);
  }
};
```

### 8. Build and Test

1. Build the app in Xcode (Cmd+B)
2. Run on simulator or device
3. Add widget to home screen (long press → + button → FitTracker)

## Widget Update Flow

```
React Native App (JS)
    ↓
Native Module Bridge (Objective-C/Swift)
    ↓
SharedDataManager.saveWidgetData()
    ↓
UserDefaults (App Group)
    ↓
WidgetKit reloadAllTimelines()
    ↓
Widget Updates on Home Screen
```

## File Structure

```
ios/
├── FitTracker/                      # Main app target (generated)
│   ├── AppDelegate.*
│   ├── Info.plist
│   └── FitTracker.entitlements
│
├── FitTrackerWidget/                # Widget Extension (custom)
│   ├── FitTrackerWidget.swift       # Entry point
│   ├── WidgetViews.swift            # UI components
│   ├── WidgetTimelineProvider.swift # Data refresh
│   ├── Info.plist
│   └── Assets.xcassets/
│
└── Shared/                          # Shared between app & widget
    ├── SharedDataManager.swift      # App Group data manager
    └── WidgetData.swift             # Data models
```

## Troubleshooting

### Widget not updating?
- Check App Group is configured in both targets
- Verify group ID matches in code: `group.com.fittracker.app`
- Check Xcode console for logs

### Build errors?
- Ensure Swift files are added to Widget Extension target (not main app)
- Check Info.plist is configured correctly
- Clean build folder (Cmd+Shift+K) and rebuild

### Widget shows placeholder?
- App hasn't written data yet
- Check SharedDataManager logs
- Manually trigger: `WidgetCenter.shared.reloadAllTimelines()`

## Resources

- [Apple WidgetKit Documentation](https://developer.apple.com/documentation/widgetkit)
- [App Groups Documentation](https://developer.apple.com/documentation/bundleresources/entitlements/com_apple_security_application-groups)
- [Expo Custom Native Code](https://docs.expo.dev/workflow/customizing/)

